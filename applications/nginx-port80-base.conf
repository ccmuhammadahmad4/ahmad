# NGINX PORT 80 BASE CONFIGURATION
# Main server block with common settings
# Individual apps included via separate files

server {
    listen 80;
    server_name localhost 172.25.25.140 _;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    
    # Include individual app configurations
    include apps/app1-routing.conf;
    include apps/app2-routing.conf;
    include apps/app3-routing.conf;
    include apps/app4-routing.conf;
    include apps/app5-routing.conf;
    
    # API Status endpoint
    location /api/status {
        access_log off;
        return 200 '{"status":"healthy","port":80,"apps":["app1","app2","app3","app4","app5"],"timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }
    
    # App selector API
    location /api/apps {
        access_log off;
        return 200 '{"apps":[
            {"name":"app1","url":"/app1/","theme":"blue","port":5001},
            {"name":"app2","url":"/app2/","theme":"green","port":5002},
            {"name":"app3","url":"/app3/","theme":"purple","port":5003},
            {"name":"app4","url":"/app4/","theme":"orange","port":5004},
            {"name":"app5","url":"/app5/","theme":"red","port":5005}
        ]}';
        add_header Content-Type application/json;
    }
    
    # Root route - JSON response with app links
    location = / {
        return 200 '{"message":"FastAPI Application Suite","note":"Access apps via paths","apps":["/app1/","/app2/","/app3/","/app4/","/app5/"],"api":"/api/status"}';
        add_header Content-Type application/json;
    }
    
    # Health check for load balancers
    location /health {
        access_log off;
        return 200 'OK';
        add_header Content-Type text/plain;
    }
    
    # Block common attack paths
    location ~ /\. { deny all; }
    location ~ \.(env|conf|log)$ { deny all; }
    
    # Error pages
    error_page 404 = @not_found;
    location @not_found {
        return 404 '{"error":"Not found","available_apps":["/app1/","/app2/","/app3/","/app4/","/app5/"]}';
        add_header Content-Type application/json;
    }
    
    # Logs - Commented out to use per-app logs defined in location blocks
    # access_log C:/nginx/logs/all_apps_access.log combined;
    # error_log C:/nginx/logs/all_apps_error.log warn;
}